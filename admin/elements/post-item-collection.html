<!--
Display items in a post folder
-->
<dom-module id="post-item-collection">
	<template>
		<iron-ajax
			id="loader"
			auto
			method="POST",
			url=[[urlToAdminPhp]]
			content-type="application/json"
			body=[[ajaxBody]]
			handle-as="json"
			last-response="{{itemCollection}}"
			debounce-duration="100"
			loading={{loading}}
			on-error = "_onError"></iron-ajax>

		<template is="dom-if" if="{{loading}}">
			<paper-progress indeterminate></paper-progress>
		</template>
		<paper-card class="grid-item" heading="Upload">
			<file-upload id="fileUpload" droppable="true" raised="true" multi="true">Choose File</file-upload>
		</paper-card>

		<iron-selector attr-for-selected="fileName" on-selected-changed="_selectPost" selected={{itemName}}>
			<template is="dom-repeat" items={{itemCollection}} sort="_compare">
				<file-item class="grid-item" content-type="post-item" file-name={{item}} parent-path={{postFolderPath}}></file-item>
			</template>
		</iron-selector>

		<style>
			paper-progress {
				width: 100%;
			}
			file-item {
				display: inline-block;
			}
			.iron-selected {
				background: var(--default-primary-color);
			}
		</style>
	</template>
	<script>
		Polymer({
			is: 'post-item-collection',

			ready: function() {
				this.urlToAdminPhp = page.urlToAdminPhp;
			},

			properties: {
				postId: String,
				ajaxBody: {
					type: String,
					computed: "_computeAjaxBody(postFolderPath)"
				},
				postFolderPath: {
					type: String,
					computed: "_computePostFolderPath(postId)"
				},
				itemCollection: Array
			},

			listeners: {
				"refresh-collection": "_reload"
			},

			_reload: function(e) {
				this.itemCollection = e.detail.newCollection; //reload the collection
				if (e.detail.changedItem) {
					this.itemName = e.detail.changedItem;
				}
			},

			_onError: function(e) {
				this.fire("raise-alert-error", e.detail.error);
			},

			_computeAjaxBody: function(postFolderPath) {
				if (postFolderPath) {
					return {action: "ls", path: postFolderPath};
				}
			},
			_selectPost: function(e) {
				//TODO
				console.log("View "+e.detail.value);
			},

			_computePostFolderPath: function(postId) {
				return "content/blog/" + postId;
			},

			_compare: function(a, b) {
				var isMdA = app.helper.isMarkdown(a);
				var isMdB = app.helper.isMarkdown(b);
				var isBakA = app.helper.isTemp(a);
				var isBakB = app.helper.isTemp(b);

				if (isMdA && isMdB) {
					return this._compareTwoMd(a, b);
				}
				else if (isMdA) {
					return -1;
				}
				else if (isMdB) {
					return 1;
				}
				else if (isBakA && isBakB) {
					return a.localeCompare(b);
				}
				else if (isBakA) {
					return 1;
				}
				else if (isBakB) {
					return -1;
				}
				return a.localeCompare(b);
			},

			_compareTwoMd: function(a, b) {
				return b.localeCompare(a);
			}
		});
	</script>

</dom-module>
